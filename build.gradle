import org.xml.sax.helpers.DefaultHandler
import javax.tools.ToolProvider
import javax.xml.parsers.SAXParserFactory
import java.security.MessageDigest


plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.0'
    id 'io.spring.dependency-management' version '1.1.4'
    id 'org.hidetake.ssh' version '2.11.2'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web:3.2.0'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa:3.2.0'
    implementation 'org.springframework.boot:spring-boot-starter-security:3.2.0'
    implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
    implementation 'io.jsonwebtoken:jjwt-impl:0.12.3'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.12.3'
    runtimeOnly 'org.postgresql:postgresql:42.6.0'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}



group = 'org.example'
version = '1.0'
description = 'backend'
java.sourceCompatibility = JavaVersion.VERSION_17



ssh.settings {
    knownHosts = allowAnyHosts
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

tasks.withType(Javadoc).configureEach {
    options.encoding = 'UTF-8'
}

def getRequiredProperty(String name) {
    return project.findProperty("deploy.$name") ?:
            System.getenv("DEPLOY_${name.toUpperCase()}")
            throw new GradleException("–ù–µ –∑–∞–¥–∞–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ: deploy.$name")
}



//TODO: test diff report + functional tests(15)



// task scp
tasks.register('scp') {
    group = 'Deployment'
    description = 'Deploys JAR via SCP'
    dependsOn tasks.named('build')

    notCompatibleWithConfigurationCache("SSH task doesn't support config cache")

    doLast {
        def remoteHost = getRequiredProperty('host')
        def remoteUser = getRequiredProperty('user')
        def remoteDir = getRequiredProperty('dir')
        def sshKey = file("${System.getProperty('user.home')}/.ssh/id_rsa")

        exec {
            commandLine 'scp', '-i', sshKey.absolutePath,
                    layout.buildDirectory.file("libs/backend-1.0-plain.jar").get().asFile.absolutePath,
                    "$remoteUser@$remoteHost:~/$remoteDir/"
        }
    }
}

// test
tasks.register('testTask') {
    doLast {
        println 'test done completely!'
    }
}

// task compile
tasks.register('myCompile', JavaCompile) {
    group = 'Build'
    description = '–ê–Ω–∞–ª–æ–≥ compileJava, –Ω–æ —Å –¥—Ä—É–≥–∏–º –≤—ã—Ö–æ–¥–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–æ–º'

    source = sourceSets.main.java
    classpath = sourceSets.main.compileClasspath
    destinationDirectory = file("$buildDir/my-classes")

    sourceCompatibility = JavaVersion.VERSION_17.toString()
    targetCompatibility = JavaVersion.VERSION_17.toString()

    options.encoding = 'UTF-8'
}

// task music
tasks.register('music') {
    notCompatibleWithConfigurationCache("")
    dependsOn build
    doLast {
        println "music started"
        exec {
            workingDir "${projectDir}"
            commandLine 'paplay', 'build/sounds/success.wav'
            ignoreExitValue true
        }
    }
}

tasks.register('generateChecksums') {
    group = 'Documentation'
    description = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è MD5 –∏ SHA1 –¥–ª—è JAR-—Ñ–∞–π–ª–∞'

    def jarFile = layout.buildDirectory.file("libs/${project.name}-${project.version}.jar")
    def outputFile = layout.buildDirectory.file("checksums/checksums.txt")

    inputs.file(jarFile)
    outputs.file(outputFile)

    doLast {
        def file = jarFile.get().asFile
        def md5 = MessageDigest.getInstance("MD5").digest(file.bytes).encodeHex().toString()
        def sha1 = MessageDigest.getInstance("SHA-1").digest(file.bytes).encodeHex().toString()

        outputFile.get().asFile.withWriter { writer ->
            writer.write("MD5: ${md5}\nSHA1: ${sha1}")
        }
    }
}

tasks.register('updateManifest', Jar) {
    notCompatibleWithConfigurationCache("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã")
    group = 'Documentation'
    description = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MANIFEST.MF —Å —Ö–µ—à–∞–º–∏'
    dependsOn tasks.named('jar'), tasks.named('generateChecksums')
    archiveClassifier = 'updated'

    from(zipTree(tasks.named('jar').get().archiveFile)) {
        exclude 'META-INF/MANIFEST.MF'
    }

    doFirst {
        def checksumFile = tasks.named('generateChecksums').get().outputs.files.singleFile
        def lines = checksumFile.readLines()
        def md5 = lines[0].split(': ')[1]
        def sha1 = lines[1].split(': ')[1]

        manifest {
            attributes(
                    'Implementation-Title': project.name,
                    'Implementation-Version': project.version,
                    'Created-By': "Gradle ${gradle.gradleVersion}",
                    'MD5-Hash': md5,
                    'SHA1-Hash': sha1
            )
        }
    }
}


tasks.register('packageJavadoc', Zip) {
    group = 'Documentation'
    description = '–£–ø–∞–∫–æ–≤–∫–∞ Javadoc –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤'

    dependsOn tasks.named('javadoc')
    archiveClassifier = 'javadoc'
    from tasks.named('javadoc')
}

// task doc
tasks.register('doc') {
    group = 'Documentation'
    description = '–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏'

    dependsOn tasks.named('updateManifest'), tasks.named('packageJavadoc')

    doLast {
        logger.lifecycle("""
        ===== –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞! =====
        –û—Å–Ω–æ–≤–Ω–æ–π JAR: ${tasks.named('updateManifest').get().archiveFile.get()}
        –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: ${tasks.named('packageJavadoc').get().archiveFile.get()}
        """)
    }
}

tasks.named('javadoc', Javadoc) {
    options {
        encoding = 'UTF-8'
        addBooleanOption('html5', true)
        addStringOption('Xdoclint:none', '-quiet')
        links = [
                'https://docs.oracle.com/en/java/javase/17/docs/api/',
                'https://docs.spring.io/spring-framework/docs/current/javadoc-api/'
        ]
    }

    exclude '**/internal/**'
}

// task xml
tasks.register('xml') {
    group = 'Verification'
    description = 'Validates all XML files in the project'

    def xmlFiles = layout.files(
            fileTree(projectDir) {
                include '**/*.xml'
                exclude 'build/**'
            }
    )

    inputs.files(xmlFiles)

    doLast {
        xmlFiles.each { file ->
            try {
                def factory = SAXParserFactory.newInstance()
                factory.setValidating(true)
                def parser = factory.newSAXParser()
                parser.parse(file, new DefaultHandler())
                logger.lifecycle("[VALID] ${file.name}")
            } catch (Exception e) {
                logger.error("[INVALID] ${file.name}: ${e.message}")
                throw new GradleException("XML validation failed for ${file.name}")
            }
        }
    }
}

// task build
tasks.register('buildCustom', Jar) {
    group = 'Build'
    description = '–°–æ–∑–¥–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ JAR'
    dependsOn tasks.named('myCompile')

    archiveBaseName = 'myapp-custom'
    archiveVersion = '1.0'
    manifest {
        attributes(
                'Main-Class': 'com.example.Main',
                'Created-By': 'Gradle Custom Build'
        )
    }

    from "$buildDir/classes-custom"

    from sourceSets.main.resources

    doLast {
        println "JAR —Å–æ–±—Ä–∞–Ω: ${archiveFile.get().asFile.absolutePath}"
    }
}

tasks.register('myBuild') {
    dependsOn tasks.named('buildCustom')
}

// task clean
tasks.register('myClean') {
    group = 'Build'
    description = '–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã'

    notCompatibleWithConfigurationCache('')

    doLast {
        def dirsToDelete = [
                file("$buildDir"),
                file("$projectDir/build/my-classes"),
                file("$projectDir/build/classes-custom"),
                file("$projectDir/build/checksums"),
                file("$projectDir/build/sounds"),
        ]

        dirsToDelete.each { dir ->
            if (dir.exists()) {
                dir.deleteDir()
                println "–£–¥–∞–ª–µ–Ω –∫–∞—Ç–∞–ª–æ–≥: ${dir.absolutePath}"
            }
        }

        println "===== –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ====="
    }
}

// task alt
tasks.register('alt') {
    group = 'Build'
    description = '–°–æ–∑–¥–∞—ë—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å –∑–∞–º–µ–Ω–∞–º–∏ –∏ —É–ø–∞–∫–æ–≤–∫–æ–π –≤ JAR'

    //TODO
    notCompatibleWithConfigurationCache('')

    def altSrcDir = file("$buildDir/alt-src")
    def altClassesDir = file("$buildDir/alt-classes")
    def replacements = [
            'AuthController': 'AltAuthController',
            'JwtUtil'       : 'AltJwtUtil',
            'myVariable'    : 'altVar'
            //TODO –¥–æ–±–∞–≤—å —Å–≤–æ–∏ –∑–∞–º–µ–Ω—ã
    ]

    dependsOn tasks.named('build')

    doLast {
        println "===== –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ====="

        delete altSrcDir
        copy {
            from 'src/main/java'
            into altSrcDir
        }

        // –ó–∞–º–µ–Ω—ã –≤ .java-—Ñ–∞–π–ª–∞—Ö
        fileTree(altSrcDir).matching { include '**/*.java' }.each { file ->
            def text = file.text
            replacements.each { from, to ->
                text = text.replaceAll("\\b${from}\\b", to)
            }
            file.text = text
        }

        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ –∏–º–µ–Ω–∏ public –∫–ª–∞—Å—Å–∞
        fileTree(altSrcDir).matching { include '**/*.java' }.each { file ->
            def text = file.text
            def matcher = text =~ /\bpublic\s+(class|interface|enum)\s+(\w+)/
            if (matcher.find()) {
                def className = matcher.group(2)
                def expectedFileName = "${className}.java"
                if (file.name != expectedFileName) {
                    def renamed = new File(file.parentFile, expectedFileName)
                    file.renameTo(renamed)
                }
            }
        }

        // –ö–æ–º–ø–∏–ª—è—Ü–∏—è
        delete altClassesDir
        altClassesDir.mkdirs()

        def srcFiles = fileTree(altSrcDir).files.collect { it.absolutePath }
        def classpathStr = sourceSets.main.compileClasspath.asPath

        def compiler = ToolProvider.getSystemJavaCompiler()
        if (!compiler) throw new GradleException("Java Compiler –Ω–µ –Ω–∞–π–¥–µ–Ω! –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JDK")

        def result = compiler.run(
                null, null, null,
                '-d', altClassesDir.absolutePath,
                '-classpath', classpathStr,
                '-source', '17',
                '-target', '17',
                '-encoding', 'UTF-8',
                *srcFiles
        )
        if (result != 0) {
            throw new GradleException("–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π")
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ JAR-—Ñ–∞–π–ª–∞
        def jarFile = file("$buildDir/libs/${project.name}-${project.version}-alt.jar")
        ant.jar(destfile: jarFile) {
            fileset(dir: altClassesDir)
            manifest {
                attributes 'Main-Class':'com.example.AltAuthController' // –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π alt-main
            }
        }

        println "‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π JAR —Å–æ–∑–¥–∞–Ω: ${jarFile.absolutePath}"
    }
}

// task team
tasks.register('team') {
    group = 'Build'
    description = '–°–æ–±–∏—Ä–∞–µ—Ç –¥–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–º–º–∏—Ç–∞ –∏ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç –∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã'

    notCompatibleWithConfigurationCache("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç git –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤")

    doLast {
        println "===== –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π ====="

        def git = ['git']
        def buildDirPath = "${project.buildDir}/team-builds"
        def outputZip = file("${project.buildDir}/team-artifacts.zip")

        // –ü–æ–ª—É—á–∞–µ–º –¥–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∫–æ–º–º–∏—Ç–∞
        def commits = git + ['rev-list', '--max-count=2', 'HEAD']
        def revisions = new ByteArrayOutputStream()
        exec {
            commandLine commits
            standardOutput = revisions
        }
        def commitHashes = revisions.toString().readLines()
        println "–†–µ–≤–∏–∑–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏: $commitHashes"

        def originalBranch = new ByteArrayOutputStream()
        exec {
            commandLine 'git', 'rev-parse', '--abbrev-ref', 'HEAD'
            standardOutput = originalBranch
        }
        def branchName = originalBranch.toString().trim()

        def counter = 1
        commitHashes.each { commit ->
            println "‚Üí –ß–µ–∫–∞—É—Ç –∫–æ–º–º–∏—Ç–∞ $commit"
            exec {
                commandLine 'git', 'checkout', commit
            }

            println "‚Üí –°–±–æ—Ä–∫–∞ –∫–æ–º–º–∏—Ç–∞ $commit"
            exec {
                commandLine './gradlew', 'clean', 'build'
            }

            def jarFile = file("${project.buildDir}/libs/${project.name}-${project.version}.jar")
            def destDir = file("${buildDirPath}/commit${counter}")
            destDir.mkdirs()
            copy {
                from jarFile
                into destDir
                rename { "commit${counter}.jar" }
            }

            counter++
        }

        println "‚Üí –í–æ–∑–≤—Ä–∞—Ç –∫ –∏—Å—Ö–æ–¥–Ω–æ–π –≤–µ—Ç–∫–µ $branchName"
        exec {
            commandLine 'git', 'checkout', branchName
        }

        println "‚Üí –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        ant.zip(destfile: outputZip) {
            fileset(dir: buildDirPath)
        }

        println "‚úÖ ZIP-—Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: ${outputZip.absolutePath}"
    }
}

tasks.register('native2ascii') {
    group = 'I18n'
    description = '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ ASCII-—Ñ–æ—Ä–º–∞—Ç'

    def resourcesDir = file('src/main/resources')
    def outputDir = file("$buildDir/native2ascii")

    inputs.dir(resourcesDir)
    outputs.dir(outputDir)

    doLast {
        println "–ù–∞—á–∞—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ native2ascii..."

        // –°–æ–∑–¥–∞–µ–º –≤—ã—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        outputDir.mkdirs()

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ .properties —Ñ–∞–π–ª—ã
        fileTree(resourcesDir).matching {
            include '**/*.properties'
        }.each { sourceFile ->
            try {
                // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
                def relativePath = resourcesDir.toURI().relativize(sourceFile.toURI()).getPath()
                def targetFile = new File(outputDir, relativePath)

                // –°–æ–∑–¥–∞–µ–º —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                targetFile.parentFile.mkdirs()

                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
                String content = sourceFile.getText('UTF-8')

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                StringBuilder convertedContent = new StringBuilder()
                for (int i = 0; i < content.length(); i++) {
                    char c = content.charAt(i)
                    if (c > 127) {
                        convertedContent.append(String.format("\\u%04x", (int) c))
                    } else {
                        convertedContent.append(c)
                    }
                }

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ ISO-8859-1
                targetFile.setText(convertedContent.toString(), 'UTF-8')

                println "–û–±—Ä–∞–±–æ—Ç–∞–Ω: ${relativePath}"
            } catch (Exception e) {
                throw new GradleException("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ ${sourceFile.name}", e)
            }
        }

        println "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ ${outputDir}"
    }
}

tasks.register('history') {
    group = 'Version Control'
    description = '–ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é –≤ –∏—Å—Ç–æ—Ä–∏–∏ Git'

    def successFile = file("$buildDir/last-working-version.txt")
    def diffFile = file("$buildDir/failing-changes.diff")

    doLast {
        println "üîç –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏..."

        try {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
            def isGitRepo = file('.git').exists()
            if (!isGitRepo) {
                throw new GradleException("–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º")
            }

            // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            def originalBranch = getCurrentGitBranch()
            println "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $originalBranch"

            // 3. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–º–∏—Ç–æ–≤
            def tempDir = file("$buildDir/git-history-check")
            tempDir.mkdirs()

            try {
                // 4. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤
                def commits = getGitHistory()
                if (commits.empty) {
                    throw new GradleException("Git –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                }

                // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
                if (tryCompile()) {
                    println "‚úÖ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è"
                    successFile.text = "Current version compiles successfully"
                    return
                }

                // 6. –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é
                String lastGoodCommit = null
                String firstBadCommit = commits[0]

                for (commit in commits) {
                    println "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–º–∏—Ç: ${commit.take(7)}..."

                    // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                    cloneCommitToTempDir(commit, tempDir)

                    if (tryCompileInTempDir(tempDir)) {
                        lastGoodCommit = commit
                        println "‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è: ${commit.take(7)}"
                        break
                    }
                }

                if (lastGoodCommit) {
                    // 7. –ü–æ–ª—É—á–∞–µ–º diff –º–µ–∂–¥—É –∫–æ–º–º–∏—Ç–∞–º–∏
                    def diff = getGitDiff(lastGoodCommit, firstBadCommit)
                    diffFile.text = diff
                    successFile.text = """
                    |–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è: $lastGoodCommit
                    |–ü–µ—Ä–≤–∞—è –Ω–µ—Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è: $firstBadCommit
                    |Diff —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: ${diffFile}
                    """.stripMargin()

                    println "üìù Diff —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: ${diffFile}"
                    println "üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${successFile}"
                } else {
                    throw new GradleException("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏")
                }
            } finally {
                // 8. –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
                deleteTempDir(tempDir)
            }
        } catch (Exception e) {
            throw new GradleException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ history: ${e.message}")
        }
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
def tryCompile() {
    try {
        exec {
            commandLine './gradlew', 'myCompile', '--quiet', '--no-configuration-cache'
            standardOutput = System.out
            errorOutput = System.err
        }
        return true
    } catch (Exception e) {
        return false
    }
}

def tryCompileInTempDir(File dir) {
    try {
        exec {
            workingDir dir
            commandLine './gradlew', 'myCompile', '--quiet', '--no-configuration-cache'
            standardOutput = System.out
            errorOutput = System.err
        }
        return true
    } catch (Exception e) {
        return false
    }
}

def getGitHistory() {
    def output = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'rev-list', '--reverse', 'HEAD'
        standardOutput = output
    }
    return output.toString().split('\n').toList()
}

def getCurrentGitBranch() {
    def output = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'branch', '--show-current'
        standardOutput = output
    }
    return output.toString().trim()
}

def cloneCommitToTempDir(String commit, File tempDir) {
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    deleteTempDir(tempDir)
    tempDir.mkdirs()

    // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    exec {
        workingDir tempDir
        commandLine 'git', 'clone', file('.').absolutePath, '.'
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω—ã–π –∫–æ–º–º–∏—Ç
    exec {
        workingDir tempDir
        commandLine 'git', 'checkout', commit
    }
}

def deleteTempDir(File tempDir) {
    if (tempDir.exists()) {
        delete {
            delete tempDir
        }
    }
}

def getGitDiff(String commit1, String commit2) {
    def output = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'diff', "${commit1}..${commit2}"
        standardOutput = output
    }
    return output.toString()
}

tasks.register('diff') {
    group = 'Version Control'
    description = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –ø—Ä–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö'

    // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    dependsOn 'processResources'

    // –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö (–Ω–µ –≤ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö)
    def configFile = file('src/main/resources/diff-config.properties')
    def allowedChangesFile = file('allowed-changes.txt')

    doLast {
        println "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–∞–±–æ—á–µ–π –∫–æ–ø–∏–∏..."

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        if (!file('.git').exists()) {
            throw new GradleException("–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º")
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
        if (!configFile.exists()) {
            createDefaultConfig(configFile)
            println "‚ÑπÔ∏è –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${configFile}"
        }

        // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
        def protectedPaths = loadProtectedPaths(configFile)
        println "üõ°Ô∏è –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –ø—É—Ç–∏: ${protectedPaths.join(', ')}"

        // 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        def changedFiles = getChangedFiles()
        if (changedFiles.empty) {
            println "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            return
        }

        // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if (hasProtectedChanges(changedFiles, protectedPaths)) {
            println "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –ø—É—Ç—è—Ö!"
            println "–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:\n${changedFiles.join('\n')}"
            throw new GradleException("–ö–æ–º–º–∏—Ç –∑–∞–ø—Ä–µ—â–µ–Ω: –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–∞—Ö")
        }

        // 6. –ö–æ–º–º–∏—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        commitChanges(allowedChangesFile)
    }
}

// –°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
def createDefaultConfig(File configFile) {
    configFile.parentFile.mkdirs()
    configFile.text = """
    # –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ –ø—É—Ç–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
    protected.paths=src/main/java/ru/melon_egoist/core/,src/main/java/ru/melon_egoist/config/
    
    # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã (true/false)
    ignore.tests=true
    """.stripIndent().trim()
}

// –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞—â–∏—â—ë–Ω–Ω—ã–µ –ø—É—Ç–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
def loadProtectedPaths(File configFile) {
    def props = new Properties()
    configFile.withInputStream { props.load(it) }

    def paths = props.getProperty('protected.paths', '')
            .split(',')
            .collect { it.trim() }
            .findAll { it }

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (props.getProperty('ignore.tests', 'true').toBoolean()) {
        paths += 'src/test/'
    }

    return paths
}

// –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
def getChangedFiles() {
    def output = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'diff', '--name-only', 'HEAD'
        standardOutput = output
    }
    return output.toString().split('\n').findAll { it }.collect { it.trim() }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
def hasProtectedChanges(List<String> changedFiles, List<String> protectedPaths) {
    return changedFiles.any { file ->
        protectedPaths.any { path ->
            file.contains(path)
        }
    }
}

// –í—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–º–∏—Ç
def commitChanges(File messageFile) {
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    exec { commandLine 'git', 'add', '.' }

    // –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
    def message = messageFile.exists() ?
            messageFile.text.trim() :
            "Autocommit: " + new Date().toString()

    // –ö–æ–º–º–∏—Ç
    exec {
        commandLine 'git', 'commit', '-m', message
        ignoreExitValue = true // –ù–µ –ø–∞–¥–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
    }

    println "üíæ –í—ã–ø–æ–ª–Ω–µ–Ω –∫–æ–º–º–∏—Ç: ${message}"
}